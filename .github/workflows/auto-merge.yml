name: Auto Merge PRs

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    if: github.event.pull_request.draft == false # 드래프트 PR은 제외
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 모든 히스토리를 가져와야 diff 비교 가능

      - name: Check workflow changes
        id: check_workflow
        run: |
          # main 브랜치와 현재 PR 브랜치 비교
          if git diff --name-only origin/main...HEAD | grep -q '^\.github/workflows/'; then
            echo "Workflow files changed, skipping auto-merge."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto merge PR
        # workflow 수정이 없고, automerge-action 자체의 로직을 믿고 맡기는 편이 더 안정적입니다.
        if: steps.check_workflow.outputs.skip == 'false'
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash
          # mergeable_state를 직접 체크하기보다 action 내부 필터링을 쓰는 것이 좋습니다.
          MERGE_FILTER_AUTHOR: "" # 특정 작성자만 원하면 추가
